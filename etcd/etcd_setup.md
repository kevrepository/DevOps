# Установка и настройка etcd

Ниже приведён пошаговый гайд с комментариями, пояснениями и готовыми
командами.

------------------------------------------------------------------------

## 1. Клонирование репозитория и сборка etcd

``` bash
git clone -b v3.6.0 https://github.com/etcd-io/etcd.git
cd etcd/
./scripts/build.sh
```

**Комментарий:**\
Команда `build.sh` создаёт бинарные файлы etcd и etcdctl в каталоге
`./bin`.

------------------------------------------------------------------------

## 2. Копирование бинарников

``` bash
cp ./bin/* /usr/local/bin/
```

**Комментарий:**\
Размещаем бинарные файлы в стандартном системном каталоге, чтобы их
можно было запускать из любой точки.

------------------------------------------------------------------------

## 3. Создание системного пользователя etcd

``` bash
useradd --system --home /var/lib/etcd --shell /sbin/nologin etcd
```

**Комментарий:**\
Пользователь не имеет shell и предназначен только для запуска сервиса.

------------------------------------------------------------------------

## 4. Подготовка каталогов данных и конфигурации

``` bash
mkdir -p /var/lib/etcd
chown -R etcd:etcd /var/lib/etcd

mkdir -p /etc/etcd
chown -R etcd:etcd /etc/etcd
```

**Комментарий:**\
`/var/lib/etcd` --- каталог данных.\
`/etc/etcd` --- каталог конфигурации.

------------------------------------------------------------------------

## 5. Файл systemd: `/etc/systemd/system/etcd.service`

``` bash
sudo tee /etc/systemd/system/etcd.service > /dev/null <<'EOF'
[Unit]
Description=etcd key-value store
Documentation=https://etcd.io/docs/
After=network-online.target
Wants=network-online.target

[Service]
User=etcd
Type=notify
ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.yml
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
```

**Комментарий:**\
Сервис запускается от пользователя `etcd`, использует конфигурационный
файл `/etc/etcd/etcd.yml`.

------------------------------------------------------------------------

## 6. Проверка здоровья узлов кластера

``` bash
etcdctl --endpoints=http://192.168.86.2:2379,http://192.168.86.3:2379,http://192.168.86.4:2379 endpoint health -w table
```

**Комментарий:**\
Показывает, отвечает ли каждый endpoint и какая задержка.

------------------------------------------------------------------------

## 7. Проверка статуса узлов

``` bash
etcdctl --endpoints=http://192.168.86.2:2379,http://192.168.86.3:2379,http://192.168.86.4:2379 endpoint status -w table
```

**Комментарий:**\
Вывод включает лидера, размер DB, версию и пр.

------------------------------------------------------------------------

## 8. Проверка списка членов кластера

``` bash
etcdctl --endpoints=http://192.168.86.2:2379 member list -w table
```

**Комментарий:**\
Позволяет убедиться, что все ноды корректно зарегистрированы.

------------------------------------------------------------------------
